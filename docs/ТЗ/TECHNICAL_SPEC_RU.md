# Техническое задание (ТЗ) — Shariat Bot / Web

Версия: 0.1 (черновик)
Дата: 2025-12-23
Основание: текущее состояние репозитория `shariat-from-template`.

## 1. Цель и результат

Создать и довести до production-готовности комплексный сервис:
- Telegram-бот для пользователей общины.
- Админ-панель для управления пользователями/контентом/переводами/ссылками/блэклистом.
- Публичный веб-портал знаний.

Результат проекта:
- Рабочий стенд (dev/stage/prod) с документацией, безопасностью, мониторингом и бэкапами.
- Формализованные роли и права доступа.
- Управляемые процессы публикации материалов.

## 2. Границы (Scope)

### 2.1 Входит
- Backend API (FastAPI) — бизнес-логика, хранение данных, админские и публичные эндпоинты (`backend/app/main.py`).
- Bot (aiogram) — пользовательские сценарии в Telegram (`bot/app/...`).
- React Admin — админка (`frontends/react-admin/src/main.jsx`).
- Vue Portal — публичный портал (`frontends/vue-portal/...`).
- Nginx gateway — единая точка входа и маршрутизация (`nginx/nginx.conf`).
- Postgres/Redis и оркестрация Docker Compose (`docker-compose.yml`).

### 2.2 Не входит (на текущую итерацию)
- Мобильные приложения.
- Платежи/донаты.
- Полноценная модерация UGC (если не будет требований).

## 3. Термины

- **Пользователь** — человек, взаимодействующий с ботом.
- **Админ-аккаунт** — учетная запись админки (не равна Telegram-пользователю) (`admin_accounts_table` в `backend/app/main.py`).
- **Роль** — право доступа к зонам/функциям (RBAC) (`roles_table`, `admin_account_roles_table` в `backend/app/main.py`).
- **Материалы/документы** — загруженные файлы знаний (с привязкой к теме и языку).
- **Блэклист** — публичная база записей + жалобы/апелляции и медиа.

## 4. Заинтересованные стороны и роли

### 4.1 Роли админки (RBAC)
Базовые роли (как в коде):
- `owner` — владелец (полный доступ, выдача высоких ролей).
- `superadmin` — суперадмин (почти полный доступ, но без выдачи `owner/superadmin`).
- `admin_users` — управление пользователями.
- `admin_languages` — управление языками и переводами.
- `admin_links` — управление ссылками/кнопками.
- `admin_blacklist` — управление блэклистом.
- `admin_documents` — управление документами знаний.
- `admin_templates` — управление деревьями/шаблонами (контрактные шаблоны/тематики).

Требование:
- Зафиксировать матрицу доступа «роль → действия» и сделать ее частью документации.

### 4.2 Роли продукта
- Пользователь бота.
- Модератор/редактор контента.
- Богослов/ревьюер (подтверждение материалов).
- Администратор системы.

## 5. Архитектура и ответственность компонентов

### 5.1 Nginx
Функции:
- Reverse proxy и роутинг:
  - `/api/` → backend
  - `/admin/` → react-admin
  - `/portal/` → vue-portal
  - `/bot/webhook` → bot (при webhook-режиме)
Файл: `nginx/nginx.conf`.

### 5.2 Backend (FastAPI)
Функции:
- Аутентификация админов (JWT, OTP).
- RBAC и защита эндпоинтов.
- CRUD сущностей: пользователи, роли, языки/переводы, ссылки, документы, блэклист.
- Публичные эндпоинты (например, поиск блэклиста).
- Инициализация БД на старте (создание таблиц/индексов) и автопочинка переводов.
Файлы: `backend/app/main.py`, `backend/app/config.py`, `backend/app/database.py`.

### 5.3 Bot (aiogram)

Назначение: реализует пользовательские сценарии в Telegram на базе `aiogram 3` + `aiogram_dialog`, хранит пользовательский профиль/состояния и интегрируется с backend (документы, синхронизация пользователя, блэклист), а также с AI (Fireworks) для генерации ответов.

#### 5.3.1 Точки входа и режим работы
- Entry-point: `bot/main.py` -> `app.bot.bot.main()`.
- Сейчас используется polling: `Dispatcher.start_polling(...)` (`bot/app/bot/bot.py`).
- В `nginx/nginx.conf` предусмотрен путь `/bot/webhook`, но webhook-режим в текущем коде не реализован (нужно добавить `setWebhook` и отдельный HTTP endpoint или отдельный webhook-worker).

#### 5.3.2 Конфигурация
- Конфиг-движок: Dynaconf (`bot/config/config.py`), профиль задается `ENV_FOR_DYNACONF`.
- Базовые настройки: `bot/config/settings.toml` + переопределения из `.env`/ENV.
- Ключевые параметры:
  - `BOT_TOKEN` — токен Telegram.
  - `ADMIN_IDS` — список Telegram ID админов (назначается роль `ADMIN` внутри бота, получают уведомления).
  - `ADMINS_CHAT` — чат/канал для нотификаций по регистрации.
  - `BACKEND__BASE_URL`, `BACKEND__ADMIN_EMAIL`, `BACKEND__ADMIN_PASSWORD` — доступ бота к backend.
  - `AI_API_KEY`, `AI_BASE_URL`, `AI_MODEL`, `AI_FIREWORKS_ACCOUNT` — доступ к Fireworks (опционально).
  - `FEATURES__ENABLE_NATS`, `FEATURES__ENABLE_TASKIQ` — фичефлаги инфраструктуры.

#### 5.3.3 Инфраструктура и хранилища
- Postgres: бот напрямую подключается к Postgres через `psycopg_pool` (`bot/app/bot/bot.py`) и использует собственные таблицы (пользовательский профиль, переводы, документы, промпты и т.п.).
- FSM storage:
  - если включен NATS (`features.enable_nats`) — используется JetStream storage (`NatsStorage`), иначе `MemoryStorage`.
- Redis:
  - опционально используется как кэш (`settings.cache.use_cache`) и/или как result backend для TaskIQ.
- TaskIQ:
  - брокер запускается всегда (`broker.startup()`), но часть команд (`/delay`, `/periodic` и т.п.) в текущем UI возвращает «scheduler unavailable», если фичи не включены.

#### 5.3.4 Middleware (поток обработки апдейтов)
Подключены middleware (и для updates, и для ошибок, и для dialog observers):
- `DataBaseMiddleware` — прокидывает DB контекст.
- `GetUserMiddleware` — загружает `user_row` из БД.
- `RegistrationGuardMiddleware` — блокирует любые сценарии, пока пользователь не зарегистрирован (кроме `/start` и выбора языка регистрации).
- `ShadowBanMiddleware` — если `user_row.banned=true`, блокирует сценарии и показывает кнопку «Запросить разбан», пропуская только флоу апелляции.
- `TranslatorRunnerMiddleware` — i18n.

#### 5.3.5 Структура кода бота (основные каталоги)
- `bot/app/bot/handlers/commands.py` — `/start`, регистрация (FSM), `/lang`, `/help`, запрос разбана.
- `bot/app/bot/handlers/comitee.py` — основное меню и сценарии (знания, блэклист, комитет, документы/шаблоны договоров, AI-подсказки и др.).
- `bot/app/bot/handlers/comitee_menu.py` — упрощенное меню (в проекте присутствует как отдельный router).
- `bot/app/bot/dialogs/flows/*` — диалоги `aiogram_dialog` (например, настройки).
- `bot/app/bot/middlewares/*` — middleware (DB, user, registration guard, shadow ban, i18n).
- `bot/app/services/backend/documents.py` — HTTP-клиент к backend (документы + публичный блэклист + жалобы/апелляции).
- `bot/app/services/ai/fireworks.py` — генерация ответа AI через Fireworks (OpenAI-compatible API).
- `bot/app/services/i18n/*` — загрузка языков и переводов в runtime.

#### 5.3.6 Возможности бота (как реализовано сейчас)
1) Регистрация пользователя (FSM)
- Триггер: `/start` для незарегистрированного.
- Выбор языка через inline-кнопки.
- Шаги: имя -> email -> телефон -> подтверждение через `request_contact`.
- Валидации: имя/почта/телефон, сверка введенного телефона и телефона из контакта.
- После успешной регистрации:
  - запись в локальную БД бота,
  - выставление `phone_verified=true`,
  - установка команд меню,
  - попытка синхронизации профиля в backend через `BackendDocumentsClient.create_user(...)`.

2) Главное меню и разделы
- Меню строится по ключам i18n и поддерживает несколько языков; реализована нормализация подписи кнопок (на случай различий в пунктуации/эмодзи).
- В `comitee.py` есть inline-меню для разделов: «Мои дела», «Blacklist», «Knowledge», «Committee», «Meetings/Chats», «Enforcement», «Good deeds», «Zakat».

3) Материалы/документы
- Скачивание документов из backend: `BackendDocumentsClient.list_documents(topic)` и `download_document(document_id)`.
- Выбор документа по языку: приоритет языка пользователя, затем fallback (`backend_default_language`), затем первый доступный.
- В ряде сценариев бот отправляет пользователю PDF как `answer_document`.

4) Шаблоны договоров
- Для шаблонов договоров есть кнопка «скачать»; бот запрашивает документы в backend по topic вида `contracts.{category}.{template}` и отправляет PDF.

5) Праздники: описание + AI
- Для «праздничных» тем бот формирует текст-описание и предлагает:
  - «Спросить AI» (генерация поздравления/наставления),
  - «Скачать документ» (если найден).

6) Вопросы учёным (комитет)
- Есть сценарий пересылки вопроса и обратной доставки ответа пользователю.
- Для ответа используется state `ScholarAnswers.answer` + callback вида `reply_{userId}_{questionId}`.

7) Блэклист (публичная часть + сбор жалоб/апелляций)
- Просмотр и поиск по публичным эндпоинтам backend (`/blacklist`, `/blacklist/search`).
- Подача жалобы/апелляции в backend (`/blacklist/complaints`, `/blacklist/appeals`).
- Прикрепление медиа к жалобе/апелляции:
  - лимиты: до 5 файлов, до 20 MB на файл,
  - форматы: фото/видео,
  - команды завершения: `done/готово/...`.

8) Запрос разбана
- Если пользователь забанен (`user_row.banned=true`), middleware показывает кнопку запроса разбана.
- Пользователь вводит причину; бот сохраняет заявку в БД и уведомляет админов (`ADMIN_IDS`) или группу учёных (если настроено).

#### 5.3.7 Интеграция с backend
- Клиент: `BackendDocumentsClient`.
- Авторизация: получает JWT через backend, кеширует токен (~45 минут).
- Используется для:
  - синхронизации профиля пользователя при регистрации (`create_user`),
  - получения и скачивания документов/шаблонов,
  - работы с публичным блэклистом и подачи жалоб/апелляций.

#### 5.3.8 Уведомления пользователям
- В `bot/app/bot/bot.py` реализован `notifications_worker`:
  - периодически (каждые ~5 секунд) читает таблицу `notifications` (где `sent_at IS NULL`),
  - отправляет сообщения пользователям (пример: `kind=user_unbanned`),
  - помечает уведомления как отправленные (`sent_at=NOW()`).
- Требование: формально описать источник данных `notifications` и гарантировать, что backend и bot используют одну и ту же БД/схему для этой таблицы.

Файлы: `bot/main.py`, `bot/app/bot/bot.py`, `bot/app/bot/handlers/commands.py`, `bot/app/bot/handlers/comitee.py`, `bot/app/services/backend/documents.py`, `bot/app/services/ai/fireworks.py`, `bot/config/settings.toml`.
### 5.4 React Admin
Функции:
- UI для администрирования (в текущем виде — «толстый» файл `main.jsx`).
- Работа через `fetch` к `/api/...` с Bearer-токеном.
Файл: `frontends/react-admin/src/main.jsx`.

### 5.5 Vue Portal
Функции:
- Публичный фронт для материалов и публичных страниц.
- Сейчас заглушка; требуется реализация.
Файл: `frontends/vue-portal/src/main.js`.

### 5.6 Shared
Единые справочники для тем/кнопок/шаблонов:
- `shared/document_tree.py`
- `shared/link_slots.py`
- `shared/contract_templates.py`

## 6. Сценарии (Use Cases)

### 6.1 Пользователь (бот)

#### 6.1.1 Первый вход и регистрация
- Пользователь пишет `/start`.
- Если профиля нет в БД бота:
  - бот отправляет приветствие и предлагает выбрать язык (inline-кнопки).
  - запускается FSM регистрации:
    1) ввод ФИО,
    2) ввод email,
    3) ввод телефона,
    4) подтверждение телефона через кнопку «Поделиться контактом».
  - после успешной регистрации:
    - профиль сохраняется в БД бота,
    - телефон помечается подтвержденным,
    - (асинхронно) выполняется синхронизация профиля в backend.

#### 6.1.2 Главное меню
- После регистрации или для существующего пользователя бот показывает главное меню (reply-кнопки), построенное из i18n ключей.
- Основные разделы (как реализовано в `comitee.py`):
  - «Мои дела» (в т.ч. договоры/наследство/никах — часть пунктов может быть заглушками),
  - «Blacklist» (просмотр/поиск/жалоба/апелляция),
  - «Knowledge» (темы знаний/праздники),
  - «Committee» (вопросы учёным),
  - «Meetings/Chats», «Enforcement», «Good deeds», «Zakat» (частично справочные/ссылочные разделы).

#### 6.1.3 Материалы
- Пользователь выбирает тему/раздел.
- Бот:
  - получает список документов из backend по topic,
  - выбирает документ по языку пользователя (fallback на дефолтный язык),
  - отправляет PDF пользователю.

#### 6.1.4 Блэклист
- Просмотр: показывает список актуальных записей.
- Поиск: имя (+ опционально дата/город).
- Жалоба: пошаговый сбор данных и отправка в backend.
- Апелляция: пошаговый сбор аргументации и отправка в backend.
- Вложение медиа: пользователь прикрепляет фото/видео (до лимита), завершает командой `готово/done`.

#### 6.1.5 Блокировка и запрос разбана
- Если пользователь забанен, любые сценарии блокируются middleware и предлагается кнопка «Запросить разбан».
- Пользователь вводит причину -> заявка сохраняется -> админы получают уведомление.
### 6.2 Публичный пользователь (портал)
- Просмотр дерева тем и списков материалов.
- Скачивание/просмотр материалов.
- Публичный поиск по блэклисту (если разрешено политиками).
- Страницы: о проекте, контакты, политика конфиденциальности, условия.

### 6.3 Администратор
- Управление пользователями: бан/разбан, активность, просмотр заявок на разбан.
- Управление админ-аккаунтами и ролями: создание/удаление, назначение ролей.
- Управление языками/переводами.
- Управление ссылками/кнопками (multi-lang).
- Управление материалами/документами.
- Управление блэклистом: записи, жалобы, апелляции, медиа.

## 7. Функциональные требования

### 7.1 Auth и безопасность
- Админский login:
  - OTP-сценарий: `login-otp` → `verify-otp` → JWT.
  - Управление привязкой Telegram ID к админ-аккаунту.
- JWT:
  - Срок жизни, ротация/refresh (определить).
  - Хранение секрета вне репо, обязательность в prod.
- RBAC:
  - Все `/admin/*` эндпоинты защищены.
  - Отдельно описать высокие роли: назначение `owner/superadmin` только владельцем.

### 7.2 Пользователи (backend)
- CRUD (минимум read/list + ban/alive/delete как в API).
- Пагинация/фильтры: поиск по user_id/имени/телефону/статусам.
- Аудит действий админов (кто забанил/разбанил/удалил).

### 7.3 Документы (материалы)
- Темы документов берутся из `shared/document_tree.py`.
- Загрузка документов (admin): multipart (topic, language, file).
- Версионирование/замена файла.
- Скачивание (admin и/или portal).
- Требования к хранению:
  - P0: уйти от хранения бинарей в Postgres на объектное хранилище (S3/MinIO/FS volume) + хранить метаданные в БД.

### 7.4 Блэклист
- Публичный list/search (ограничения определить политикой).
- Админский доступ: управление статусом, просмотр жалоб/апелляций, загрузка/скачивание медиа.
- Валидация медиа (content-type/размер), ограничения и ретеншн.

### 7.5 Языки и переводы
- Справочник языков.
- Управление translation keys и translations.
- Автозаполнение/ремонт переводов (опционально AI).
- Определить процесс добавления нового языка и критерии качества перевода.

### 7.6 Ссылки/кнопки
- Набор слотов определяется в `shared/link_slots.py`.
- Редактирование ссылок по языкам.
- Использование в боте (клавиатуры) и на портале.

### 7.7 Портал (новая разработка)
Минимально необходимые страницы/разделы:
- Каталог тем (`document_tree`) → список материалов.
- Страница материала (метаданные, кнопка скачать/открыть).
- Поиск по материалам.
- Публичный поиск по блэклисту (если разрешено).
- Статические страницы: о проекте, контакты, политика, условия.

### 7.8 Telegram-бот

#### 7.8.1 Регистрация и профиль
- Обязательная регистрация перед доступом к функциям (кроме выбора языка/стартового экрана).
- Сбор данных: ФИО, email, телефон; подтверждение телефона через contact-share.
- Хранить поля профиля и статусы: язык, роль (`user/admin` в контексте бота), `banned`, `phone_verified`, заявка на разбан.
- Синхронизация профиля в backend после регистрации (best-effort, с повторными попытками/логированием).

#### 7.8.2 Меню и навигация
- Главное меню должно быть полностью локализовано (ru/en/ar/tr и др. по конфигу).
- Меню должно быть устойчивым к вариациям текста (нормализация, защита от «съехавших» эмодзи/пробелов).
- Для каждого пункта меню должны быть определены:
  - цель (что пользователь получает),
  - состояние/шаги ввода (если есть),
  - обработка ошибок.

#### 7.8.3 Документы и знания
- Получение документов из backend по topic.
- Выбор документа по языку пользователя + fallback.
- Отправка документов пользователю в Telegram (ограничение размера/таймаутов).

#### 7.8.4 Блэклист
- Просмотр/поиск через публичный API backend.
- Подача жалобы и апелляции с пошаговой валидацией полей.
- Поддержка вложений (фото/видео), лимиты и понятный UX завершения.

#### 7.8.5 AI-ответы
- AI интеграция должна быть опциональной (работоспособность без AI).
- Локализованные системные промпты и сообщения об ошибках.
- Фильтрация `<think>...</think>` из ответа.

#### 7.8.6 Админ-уведомления и модерация
- Уведомления о регистрации и заявках на разбан:
  - в чат `ADMINS_CHAT` (если настроен),
  - напрямую на `ADMIN_IDS`.
- Ответы учёных пользователю должны сохранять контекст (ID вопроса) и быть доставлены в нужный язык.

#### 7.8.7 Уведомления пользователю
- Доставка событий (например, «пользователь разбанен») из таблицы `notifications`.
- Гарантировать идемпотентность (не отправлять одно и то же уведомление повторно).
## 8. Нефункциональные требования

### 8.1 Среды и конфигурация
- `dev`, `stage`, `prod`.
- Секреты только через переменные окружения/secret store.
- Разделение конфигов для bot/backend.

### 8.2 Производительность
- Пагинация на списках.
- Индексы в Postgres под основные запросы.
- Ограничения на размер загружаемых файлов/медиа.

### 8.3 Надежность и устойчивость
- Миграции БД: явные Alembic миграции для backend (сейчас часть «bootstrap» в коде).
- Бэкапы Postgres и стратегии восстановления.
- Ретеншн логов.

### 8.4 Наблюдаемость
- Структурные логи (JSON), уровни, корреляция request_id.
- Метрики (Prometheus) и health/readiness.
- Audit log админских действий.

### 8.5 Безопасность
- CORS: запрет `*` в prod.
- Rate limit на auth и публичные методы.
- Политика доступа к публичному блэклисту.
- Политика хранения персональных данных (PII) и согласия.

## 9. API/контракты (минимум)

Требование:
- Зафиксировать OpenAPI как контракт (генерируется FastAPI), дополнить описанием полей, примерами запросов и статус-кодами.
- Ввести версионирование API (`/api/v1/...`) или зафиксировать текущую схему.

## 10. Данные (высокоуровнево)

Основные сущности:
- Пользователь (`users`): user_id (Telegram), язык, контакты, статусы (ban/alive), заявки на разбан.
- Языки/переводы: `languages`, `translation_keys`, `translations`.
- Админ-аккаунты/роли: `admin_accounts`, `roles`, `admin_account_roles`.
- Документы знаний: метаданные + ссылка на хранение файла.
- Блэклист: записи + жалобы/апелляции + медиа.
- Notifications: события/уведомления (в т.ч. для OTP).

## 11. Развертывание и эксплуатация

- CI/CD: сборка образов и деплой (есть в `.github/workflows/dev-deploy.yml`).
- Требование: отделить dev-режим фронтендов от prod (prod build + nginx static).
- Требование: описать процедуру миграций, бэкапов, ротации секретов.

## 12. Acceptance Criteria (критерии приемки)

### P0 (MVP production-ready)
- Портал реализован и доступен через `/portal/`.
- Админка доступна через `/admin/` и работает со всеми ключевыми разделами.
- Backend не использует дефолтные секреты в prod; CORS ограничен.
- Документы/медиа хранятся вне Postgres (или обоснованно остаются в нем с лимитами и бэкап-стратегией).
- Логи и базовые метрики доступны; есть health/readiness.

### P1
- Есть набор API-тестов и smoke/e2e сценарии.
- Есть аудит админских действий.
- Есть документированные процедуры деплоя/отката/восстановления.

## 13. Бэклог работ

### P0
- Реализовать портал (страницы/каталог/поиск/скачивание).
- Перевести фронтенды на production build (static) + отдача nginx.
- Вынести файлы документов/медиа в файловое или S3-хранилище.
- Зафиксировать и внедрить матрицу прав (RBAC) + UI-ограничения в админке.
- Усилить безопасность: секреты, CORS, rate limits, политики доступа к публичным данным.

### P1
- Тесты backend (RBAC, документы, блэклист, auth), smoke для фронтов.
- Observability: метрики, трассировка, аудит.
- Миграции backend через Alembic (единый процесс, без «bootstrap» в runtime для prod).

### P2
- Процесс публикации материалов (статусы, ревью, роли контент-команды).
- Политики приватности/согласий/удаления данных.
- Масштабирование: кеширование, оптимизация запросов, очереди задач.

## 14. Открытые вопросы
- Должен ли блэклист быть публичным? Если да — какие поля доступны и какие ограничения?
- Какие форматы документов поддерживаем (PDF/DOCX/HTML), нужен ли предпросмотр?
- Требуется ли SSO/2FA помимо Telegram OTP?
- Какие языки считаются обязательными (ru/en/ar/tr/…)?



